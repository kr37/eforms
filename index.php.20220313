<?php
$debug = false;
include('env.php');
include('../wp-config.php');
$formNum = $_GET['form'];
echo <<<HEAD
    <html>
    <head>
    <title>eForms $formNum</title>
    <style>
        th    { border: 1px solid gray; padding: 0 .3em; }
        td    { border: 1px solid gray; padding: 0 .3em; }
        table { border-collapse: collapse; }
    </style>
    </head>
    <body>
    <p>Hi there! $formNum</p>
HEAD;

// Connect to the database
$mysqli = new mysqli('localhost', DB_USER, DB_PASSWORD, DB_NAME);

if (!$formNum) { //If no form number was given, display some choices
    echo "<p>Choose a form:</p>\n";
    $result = $mysqli->query("SELECT * FROM {$pfx}fsq_form WHERE 1 ORDER BY id DESC");
    $forms = $result->fetch_all(MYSQLI_ASSOC); 
    foreach ($forms as $form) {
        echo "<a href='/ef/$form[id]'>$form[id]. $form[name]</a><br>\n";
    }
    die();
} else { //If we're working on a form, give option to see other forms
    echo "<a href='/ef/'>Go to list of forms</a>";
}
    






//*** Get the form ***
$formQ = $mysqli->query("SELECT * FROM {$pfx}fsq_form WHERE id=$formNum");
$row = $formQ->fetch_assoc();

// parse out the arrays
$mcqAnswers = unserialize($row['mcq']); 
$form['layout']   = unserialize($row['layout']); 
$form['mcq']      = unserialize($row['mcq']); 
$form['freetype'] = unserialize($row['freetype']); 
$form['design']   = unserialize($row['design']); 
$form['pinfo']    = unserialize($row['pinfo']); 
if ($formNum == 85) {
    $form['mcq'][39]['settings']['options'][2]['label'] = 'single';
    $form['mcq'][41]['settings']['options'][0]['label'] = 'ensuite single';
}

//Display the name of the form
echo "<h2>$row[name]</h2>\n"; 

if ($debug) {
    foreach($form['mcq'] as $qi => $question) {
        echo "<br>$qi: ";
        foreach($question['settings']['options'] as $ai => $answer)
            echo "$ai $answer[label],";
    }
//$td = $form[$type][$question]['settings']['options'][$answerNum]['label'];
}

/*
// Get Fields by Layout
$elements = $form['layout'][0]['elements']; //All the fields in the form
$fieldsByLayout = [];
foreach($elements as $layoutIndex => $element) {
    $type   = $element['type'];
    if ($type !== 'embed') {
        $m_type = $element['m_type'];
        $key    = $element['key'];
        $title  = $form[$m_type][$key]['title']
                  . ($form[$m_type][$key]['subtitle'] ? ' ~ '.$form[$m_type][$key]['subtitle'] : '');
        $fieldsByLayout[$layoutIndex]  = ['m_type' => $m_type, 'type' => $type, 'key' => $key, 'title' => $title];
        //echo "fieldsByLayout[$layoutIndex] = ['m_type' => $m_type, 'type' => $type, 'key' => $key, 'title' => $title]<br>";
    }
}

// Sort them to our liking, and add payment details
$columns  = ['f_name','l_name','email'];
foreach ($columns as $c) {
    $layoutIndex = array_search($c, array_map(function($val){return $val['type'];}, $fieldsByLayout));
    if (array_key_exists($layoutIndex, $fieldsByLayout)) {
        $key = $fieldsByLayout[$layoutIndex]['key'];
        $first[$key] = $fieldsByLayout[$layoutIndex];
        unset($fieldsByLayout[$layoutIndex]);
    }
}
$first['amount'] = ['m_type' => 'fsq_payment', 'type' => 'amount', 'key' => 'amount', 'title' => 'Amount Paid'];
$first['date']   = ['m_type' => 'fsq_payment', 'type' => 'date',   'key' => 'date',   'title' => 'Date'];
//foreach($first as $i=>$f) echo "first[$i] = $f[title]<br>";
//foreach($fieldsByLayout as $i=>$f) echo "fieldsByLayout[$i] = $f[title]<br>";
$fieldsByKey     = array_replace($first, $fieldsByLayout);
//foreach($fieldsByKey as $i=>$f) echo "fieldsByKey[$i] = $f[title]<br>";
*/

//*** Work out the columns to display from amongst all the data ***
$columns  = ['f_name','l_name','email','amount','date'];
$elements = $form['layout'][0]['elements']; //All the fields in the form
$fields   = []; // $fields[$questionIndex] = ['mcq/freetype', $key, $title]
$stats    = []; // $stats[$question, $answer] = some count
$statmode = []; // $statmode[$question] = 'count' or 'sum' or ''
$ei       = 0;  // $ei = element index, and seems to go 0, 1, 2, 3, ... # of questions
$key      = 0;  // $key seems to be a unique index for thequestions - unique throughtout all columns (mcq, freetype, pinfo) 
foreach($elements as $ei => $element) {
    $m_type = $element['m_type'];
    $type   = $element['type'];
    if (false === array_search($type, ['f_name','l_name','email'])) {
        $key    = $element['key'];
        $title  = $form[$m_type][$key]['title']
                  . ($form[$m_type][$key]['subtitle'] ? ' ~ '.$form[$m_type][$key]['subtitle'] : '');
        if ($type !== 'embed') {
            $columns[]    = $ei;
            $fields[$ei]  = ['table' => $m_type, 'index' => $key, 'title' => $title];
            $fieldk[$key] = ['table' => $m_type, 'index' => $key, 'title' => $title];
        }
    }
}
if ($debug) {
    echo "<br><b>fields</b>"; foreach($fields as $i=>$f) echo"<br>$i: $f[table],$f[index],$f[title]";echo"<br>";
    foreach($fieldk as $i=>$f) echo "fieldk[$i] = $f[title]<br>";
}

/*
// *** Display sorting options ***
echo <<<FORMSTART
<form action="$_SERVER[REQUEST_URI]" method="GET">
    <input type="submit" value="GATE GATE">
    <table>
    <thead><tr><th>Sort</th><th>Show</td><th>Field</th></tr></thead>
    <tbody>
FORMSTART;
foreach($fieldsByKey as $q => $option) {
    echo <<<FORMROW
        <tr>
            <td><input type='radio' name='sortby'></td><td><input type='checkbox' name='include'></td><td>$option[title] ($q)</td>
        </tr>
FORMROW;
}
echo <<<FORMEND
    </tbody>
    </table>
</form>
FORMEND;
*/


//*** Show the signups - Most recent first ***
$mainQuery = "SELECT f_name,l_name,email,amount,`{$pfx}fsq_payment`.`date`,freetype,mcq 
            FROM `{$pfx}fsq_payment` 
            LEFT JOIN {$pfx}fsq_data 
                ON `{$pfx}fsq_payment`.`data_id`=`{$pfx}fsq_data`.`id` 
            WHERE `{$pfx}fsq_payment`.`form_id`=$formNum ";


/*
echo "<h2>Most Recent</h2>\n";
$result  = $mysqli->query($mainQuery. "ORDER BY `{$pfx}fsq_payment`.`date` DESC");
$signups = $result->fetch_all(MYSQLI_ASSOC); 
tableByKey($signups, -1);
*/


echo "<h2>Most Recent</h2>\n";
$result  = $mysqli->query($mainQuery. "ORDER BY `{$pfx}fsq_payment`.`date` DESC");
$signups = $result->fetch_all(MYSQLI_ASSOC); 
makeTable($signups, -1);

echo "<h2>Alphabetical</h2>\n";
$result  = $mysqli->query($mainQuery . "ORDER BY f_name ASC, l_name ASC");
$signups = $result->fetch_all(MYSQLI_ASSOC); 
makeTable($signups, 1);





function tableByKey($signups, $inc = 1) {
    global $form, $fieldsByKey, $columns;

    echo "<table>\n<thead>\n<tr>\n<td> </th>"; //Table headers
    foreach ($fieldsByKey as $f)
        echo "<th>$f[title]</th>";
    echo "</tr>\n";
    $x = ($inc < 0) ? count($signups) : 1;
    foreach ($signups as $i => $s) {
        $s['mcq']      = unserialize($s['mcq']);
        $s['freetype'] = unserialize($s['freetype']);
        $s['pinfo']    = unserialize($s['pinfo']);
        echo "<tr><td>$x</td>"; $x = $x + $inc;
        foreach ($fieldsByKey as $key => $fields) {
$td = "k=$key";
            /*if (is_numeric($key)) {
                $type     = $fields['type'];
                $question = $fields['index'];
//echo "<td>Numeric$type $question</td>";
                switch ($type) {
                    case 'mcq':
//echo "<pre>". var_export($s[$type],true)."</pre>";
                        $answerNum = $s[$type][$key]['options'][0];
                        $td = $form[$type][$key]['settings']['options'][$answerNum]['label'];
                        break;
                    case 'freetype':
                        $td = $s[$type][$question]['value'];
                        break;
                    case 'pinfo':
                        $answerNum = $s[$type][$question]['options'][0];
                        $td = $form[$type][$question]['settings']['options'][$answerNum]['label'];
                        break;
                    default:
                        $td = $type;
                }
            } else {
                $td = $s[$key];
            }*/
            echo "<td>$td</td>";
        }
        echo "</tr>\n";
    }
    echo "</tbody>\n</table>\n";
}





function makeTable($signups, $inc = 1) {
    global $form, $fields, $fieldk, $columns, $formNum;

    echo "<table>\n<thead>\n<tr>\n<td> </th>"; //Table headers
    foreach ($columns as $c) {
        if ($c != '') {
            if (is_numeric($c)) {
                echo "<th>". $fields[$c]['title'].'</th>';
            } else {
                echo "<th>$c</th>";
            }
        }
    }
    echo "</tr>\n";
    $x = ($inc < 0) ? count($signups) : 1;
    foreach ($signups as $i => $s) {
        $s['mcq']      = unserialize($s['mcq']);
        $s['freetype'] = unserialize($s['freetype']);
        $s['pinfo']    = unserialize($s['pinfo']);
        echo "<tr><td>$x</td>"; $x = $x + $inc;
        foreach ($columns as $c) {
            if (is_numeric($c)) {
                $type     = $fields[$c]['table'];
                $question = $fields[$c]['index'];
                switch ($type) {
                    case 'mcq':
                        $answerNum = $s[$type][$question]['options'][0];
                        $td = $form[$type][$question]['settings']['options'][$answerNum]['label'];
                        if (!$td & $formNum==85) {
                            $td = $answerNum;
                        }
                        break;
                    case 'freetype':
                        $td = $s[$type][$question]['value'];
                        break;
                    case 'pinfo':
                        $answerNum = $s[$type][$question]['options'][0];
                        $td = $form[$type][$question]['settings']['options'][$answerNum]['label'];
                        break;
                    default:
                        $td = $type;
                }
            } else {
                $td = $s[$c];
            }
            echo "<td>$td</td>";
        }
        echo "</tr>\n";
    }
    echo "</tbody>\n</table>\n";
}







// Simpler table
echo "<table>";

// Show the signups - Alphabetical
echo "<h2>Alphabetical</h2>";
$count = 0; $first = 1; $inPerson = 0;
$result = $mysqli->query("SELECT f_name,l_name,email,mcq,amount,`{$pfx}fsq_payment`.`date` FROM `{$pfx}fsq_payment` LEFT JOIN {$pfx}fsq_data ON `{$pfx}fsq_payment`.`data_id`=`{$pfx}fsq_data`.`id` WHERE `{$pfx}fsq_payment`.`form_id`=$formNum ORDER BY f_name ASC,l_name ASC");
echo "<table>";
while ($row = $result->fetch_assoc()) {
    if ($first) {
        $first = 0;
        echo "<th>";
        foreach ($row as $key => $value)
            echo "<td><b>$key</b></td>";
        echo "</th>";
    }

    $count++;
    echo "<tr><td>$count</td>";
    // parse out the mcq array (multiple-choice-questions?)
    $mcqArray = unserialize($row['mcq']); 
    $row['mcq'] = '';
    foreach ($mcqArray as $key => $question){
        $row['mcq'] .= $mcqAnswers[$key]['settings']['options'][$question['options'][0]]['label'] . '<br> ';
        if (strpos($row['mcq'], 'person')) $inPerson++;
    }
    //Display
    foreach ($row as $key => $value)
        echo "<td>$value</td>";
    echo "</tr>";
}
echo "</table>";
echo "$inPerson in person.";


?>
</body>
</html>
